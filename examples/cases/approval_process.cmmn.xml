<?xml version="1.0" encoding="UTF-8"?>
<definitions xmlns="http://www.omg.org/spec/CMMN/20151109/MODEL"
             xmlns:flowable="http://flowable.org/cmmn"
             targetNamespace="http://flowable.org/cmmn">

  <case id="approvalProcess" name="Simple Approval Process">
    
    <casePlanModel id="approvalPlanModel" name="Approval Plan">
      
      <!-- Human Task: Request Review -->
      <planItem id="planItem_submitRequest" definitionRef="submitRequest"/>
      <planItem id="planItem_reviewRequest" definitionRef="reviewRequest">
        <entryCriterion id="afterSubmit" sentryRef="sentry_afterSubmit"/>
      </planItem>
      <planItem id="planItem_finalApproval" definitionRef="finalApproval">
        <entryCriterion id="afterFirstReview" sentryRef="sentry_afterFirstReview"/>
      </planItem>
      
      <!-- Milestones -->
      <planItem id="planItem_requestSubmitted" definitionRef="requestSubmitted"/>
      <planItem id="planItem_approved" definitionRef="approved">
        <entryCriterion id="whenApproved" sentryRef="sentry_whenApproved"/>
      </planItem>
      <planItem id="planItem_rejected" definitionRef="rejected">
        <entryCriterion id="whenRejected" sentryRef="sentry_whenRejected"/>
      </planItem>
      
      <!-- Task Definitions -->
      <humanTask id="submitRequest" name="Submit Request" flowable:assignee="${initiator}">
        <extensionElements>
          <flowable:formProperty id="title" name="Request Title" type="string" required="true"/>
          <flowable:formProperty id="description" name="Description" type="string"/>
          <flowable:formProperty id="amount" name="Amount" type="long"/>
          <flowable:formProperty id="priority" name="Priority" type="string"/>
        </extensionElements>
      </humanTask>
      
      <humanTask id="reviewRequest" name="Review Request" flowable:candidateGroups="managers">
        <extensionElements>
          <flowable:formProperty id="reviewDecision" name="Decision" type="string" required="true"/>
          <flowable:formProperty id="reviewComment" name="Comment" type="string"/>
        </extensionElements>
      </humanTask>
      
      <humanTask id="finalApproval" name="Final Approval" flowable:candidateGroups="directors">
        <extensionElements>
          <flowable:formProperty id="finalDecision" name="Final Decision" type="boolean" required="true"/>
          <flowable:formProperty id="finalComment" name="Comment" type="string"/>
        </extensionElements>
      </humanTask>
      
      <!-- Milestones -->
      <milestone id="requestSubmitted" name="Request Submitted"/>
      <milestone id="approved" name="Request Approved"/>
      <milestone id="rejected" name="Request Rejected"/>
      
      <!-- Sentries -->
      <sentry id="sentry_afterSubmit">
        <planItemOnPart sourceRef="planItem_submitRequest">
          <standardEvent>complete</standardEvent>
        </planItemOnPart>
      </sentry>
      
      <sentry id="sentry_afterFirstReview">
        <planItemOnPart sourceRef="planItem_reviewRequest">
          <standardEvent>complete</standardEvent>
        </planItemOnPart>
        <ifPart>
          <condition><![CDATA[${reviewDecision == 'approve' && amount > 10000}]]></condition>
        </ifPart>
      </sentry>
      
      <sentry id="sentry_whenApproved">
        <planItemOnPart sourceRef="planItem_finalApproval">
          <standardEvent>complete</standardEvent>
        </planItemOnPart>
        <ifPart>
          <condition><![CDATA[${finalDecision == true}]]></condition>
        </ifPart>
      </sentry>
      
      <sentry id="sentry_whenRejected">
        <planItemOnPart sourceRef="planItem_reviewRequest">
          <standardEvent>complete</standardEvent>
        </planItemOnPart>
        <ifPart>
          <condition><![CDATA[${reviewDecision == 'reject'}]]></condition>
        </ifPart>
      </sentry>
      
    </casePlanModel>
  </case>
  
</definitions>
